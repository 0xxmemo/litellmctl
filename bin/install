#!/usr/bin/env bash
set -euo pipefail

BIN_DIR="$(cd "$(dirname "$0")" && pwd)"
PROJECT_DIR="$(cd "$BIN_DIR/.." && pwd)"
VENV_DIR="$PROJECT_DIR/venv"
SUBMODULE_DIR="$PROJECT_DIR/litellm"

USE_LOCAL=false
while [[ $# -gt 0 ]]; do
  case "$1" in
    --local) USE_LOCAL=true; shift ;;
    *)       shift ;;
  esac
done

# ── Helpers ──

info()  { printf "\033[1;34m==> %s\033[0m\n" "$*"; }
warn()  { printf "\033[1;33m==> %s\033[0m\n" "$*"; }
error() { printf "\033[1;31m==> %s\033[0m\n" "$*" >&2; }

has_local_changes() {
  local dir="$1"
  [ -d "$dir/.git" ] || [ -f "$dir/.git" ] || return 1
  git -C "$dir" fetch --quiet 2>/dev/null || true
  # Uncommitted changes (staged or unstaged)
  ! git -C "$dir" diff --quiet 2>/dev/null && return 0
  ! git -C "$dir" diff --cached --quiet 2>/dev/null && return 0
  # Unpushed commits ahead of remote
  local ahead
  ahead=$(git -C "$dir" rev-list --count @{u}..HEAD 2>/dev/null || echo "0")
  [ "$ahead" -gt 0 ] && return 0
  return 1
}

prompt_local_changes() {
  local dir="$1" label="$2"
  echo ""
  warn "Local changes detected in $label:"
  git -C "$dir" diff --stat 2>/dev/null
  git -C "$dir" diff --cached --stat 2>/dev/null
  local ahead
  ahead=$(git -C "$dir" rev-list --count @{u}..HEAD 2>/dev/null || echo "0")
  [ "$ahead" -gt 0 ] && info "$ahead unpushed commit(s) ahead of remote"
  echo ""
  printf "  [K]eep local  [S]tash & sync  [D]iscard & sync  [K/s/d] "
  read -r answer
  case "$answer" in
    [sS]*) echo "stash" ;;
    [dD]*) echo "discard" ;;
    *)     echo "keep" ;;
  esac
}

sync_repo() {
  local dir="$1" label="$2"
  if has_local_changes "$dir"; then
    if $USE_LOCAL; then
      info "Local changes in $label — skipping sync (--local)."
      return 0
    fi
    local choice
    choice=$(prompt_local_changes "$dir" "$label")
    case "$choice" in
      keep)
        info "Keeping local $label. Skipping sync."
        ;;
      stash)
        info "Stashing $label changes ..."
        git -C "$dir" stash --quiet
        info "Pulling $label ..."
        git -C "$dir" pull --ff-only || { error "Pull failed for $label."; exit 1; }
        info "Restoring stashed $label changes ..."
        git -C "$dir" stash pop --quiet 2>/dev/null || {
          warn "Could not auto-restore $label changes. Check: git -C $dir stash list"
        }
        ;;
      discard)
        warn "Discarding local $label changes."
        git -C "$dir" checkout . 2>/dev/null || true
        git -C "$dir" clean -fd 2>/dev/null || true
        git -C "$dir" pull --ff-only || { error "Pull failed for $label."; exit 1; }
        ;;
    esac
  else
    info "Pulling $label ..."
    git -C "$dir" pull --ff-only || { error "Pull failed for $label."; exit 1; }
  fi
}

detect_python() {
  for cmd in python3 python; do
    if command -v "$cmd" &>/dev/null; then
      local ver
      ver=$("$cmd" -c 'import sys; print(sys.version_info[:2] >= (3,9))' 2>/dev/null || echo "False")
      if [ "$ver" = "True" ]; then
        echo "$cmd"
        return
      fi
    fi
  done
  error "Python 3.9+ not found."
  case "$OSTYPE" in
    darwin*) echo "  brew install python3" ;;
    linux*)  echo "  sudo apt install python3 python3-venv" ;;
  esac
  exit 1
}

# ── Platform checks ──

info "LiteLLM Proxy Installer (fork: 0xxmemo/litellm)"
echo ""

PYTHON="$(detect_python)"
PY_VERSION="$($PYTHON --version 2>&1)"
echo "  Platform: $OSTYPE"
echo "  Python:   $PY_VERSION ($PYTHON)"
echo ""

if [[ "$OSTYPE" == linux* ]]; then
  if ! $PYTHON -c "import venv" 2>/dev/null; then
    warn "python3-venv not found — installing ..."
    sudo apt-get update -qq && sudo apt-get install -y -qq python3-venv
  fi
  if ! $PYTHON -c "import ensurepip" 2>/dev/null; then
    warn "python3-pip/ensurepip not found — installing ..."
    sudo apt-get update -qq && sudo apt-get install -y -qq python3-pip
  fi
fi

# ── Parent repo sync ──

if [ -d "$PROJECT_DIR/.git" ]; then
  sync_repo "$PROJECT_DIR" "parent repo"
fi

# ── Submodule ──

if [ ! -f "$SUBMODULE_DIR/pyproject.toml" ]; then
  if $USE_LOCAL; then
    error "litellm/ submodule not found and --local was specified. Cannot continue."
    info "Run without --local to initialize the submodule first."
    exit 1
  fi
  info "Initializing litellm submodule ..."
  git -C "$PROJECT_DIR" submodule update --init --depth 1 litellm
elif has_local_changes "$SUBMODULE_DIR"; then
  if $USE_LOCAL; then
    info "Local changes in litellm/ submodule — skipping sync (--local)."
  else
    choice=$(prompt_local_changes "$SUBMODULE_DIR" "litellm/ submodule")
    case "$choice" in
      keep)
        info "Keeping local submodule files. Skipping sync."
        ;;
      stash)
        info "Stashing submodule changes ..."
        git -C "$SUBMODULE_DIR" stash --quiet
        info "Syncing litellm submodule ..."
        git -C "$PROJECT_DIR" submodule sync --recursive
        git -C "$PROJECT_DIR" submodule update --init --depth 1 --force litellm
        info "Restoring stashed submodule changes ..."
        git -C "$SUBMODULE_DIR" stash pop --quiet 2>/dev/null || {
          warn "Could not auto-restore submodule changes. Check: git -C $SUBMODULE_DIR stash list"
        }
        ;;
      discard)
        warn "Discarding local submodule changes."
        info "Syncing litellm submodule ..."
        git -C "$PROJECT_DIR" submodule sync --recursive
        git -C "$PROJECT_DIR" submodule update --init --depth 1 --force litellm
        ;;
    esac
  fi
else
  info "Syncing litellm submodule ..."
  git -C "$PROJECT_DIR" submodule sync --recursive
  git -C "$PROJECT_DIR" submodule update --init --depth 1 --force litellm
fi

# ── Virtualenv ──

if [ -d "$VENV_DIR" ]; then
  if [ "${LITELLM_REINSTALL_VENV:-}" = "1" ]; then
    info "Rebuilding virtualenv ..."
    rm -rf "$VENV_DIR"
    $PYTHON -m venv "$VENV_DIR"
  else
    info "Reusing existing virtualenv."
  fi
else
  info "Creating virtualenv at $VENV_DIR ..."
  $PYTHON -m venv "$VENV_DIR"
fi

# ── Activate ──

# shellcheck disable=SC1091
source "$VENV_DIR/bin/activate"

# ── Install dependencies ──

info "Upgrading pip ..."
pip install --upgrade pip --quiet 2>/dev/null

info "Installing litellm[proxy] (editable) ..."
pip install -e "$SUBMODULE_DIR[proxy]" --quiet 2>/dev/null
info "litellm installed."

# ── .env setup ──

if [ ! -f "$PROJECT_DIR/.env" ]; then
  if [ -f "$PROJECT_DIR/.env.example" ]; then
    cp "$PROJECT_DIR/.env.example" "$PROJECT_DIR/.env"
    sed -i.bak "s|/path/to/.litellm|$PROJECT_DIR|g" "$PROJECT_DIR/.env" 2>/dev/null || true
    rm -f "$PROJECT_DIR/.env.bak"
    warn "Created .env from template — edit to add your API keys"
  else
    warn "No .env file found. Copy the example and fill in your keys:"
    echo "  cp $PROJECT_DIR/.env.example $PROJECT_DIR/.env"
  fi
fi

# ── Sync auth file paths ──

"$BIN_DIR/litellmctl" init-env 2>/dev/null || true

# ── Shell completions ──

"$BIN_DIR/litellmctl" setup-completions 2>/dev/null || true

echo ""
info "Installation complete!"
echo ""
