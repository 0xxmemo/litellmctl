#!/usr/bin/env bash
set -euo pipefail

BIN_DIR="$(cd "$(dirname "$0")" && pwd)"
PROJECT_DIR="$(cd "$BIN_DIR/.." && pwd)"
VENV_DIR="$PROJECT_DIR/venv"
SUBMODULE_DIR="$PROJECT_DIR/litellm"

# ── Helpers ──

info()  { printf "\033[1;34m==> %s\033[0m\n" "$*"; }
warn()  { printf "\033[1;33m==> %s\033[0m\n" "$*"; }
error() { printf "\033[1;31m==> %s\033[0m\n" "$*" >&2; }

confirm() {
  local prompt="$1"
  local reply
  printf "%s [y/N] " "$prompt"
  read -r reply
  case "$reply" in
    [yY]|[yY][eE][sS]) return 0 ;;
    *) return 1 ;;
  esac
}

detect_python() {
  for cmd in python3 python; do
    if command -v "$cmd" &>/dev/null; then
      local ver
      ver=$("$cmd" -c 'import sys; print(sys.version_info[:2] >= (3,9))' 2>/dev/null || echo "False")
      if [ "$ver" = "True" ]; then
        echo "$cmd"
        return
      fi
    fi
  done
  error "Python 3.9+ not found."
  case "$OSTYPE" in
    darwin*) echo "  brew install python3" ;;
    linux*)  echo "  sudo apt install python3 python3-venv" ;;
  esac
  exit 1
}

# ── Platform checks ──

info "LiteLLM Proxy Installer (fork: 0xxmemo/litellm)"
echo ""

PYTHON="$(detect_python)"
PY_VERSION="$($PYTHON --version 2>&1)"
echo "  Platform: $OSTYPE"
echo "  Python:   $PY_VERSION ($PYTHON)"
echo ""

if [[ "$OSTYPE" == linux* ]]; then
  if ! $PYTHON -c "import venv" 2>/dev/null; then
    warn "python3-venv not found — installing ..."
    sudo apt-get update -qq && sudo apt-get install -y -qq python3-venv
  fi
  if ! $PYTHON -c "import ensurepip" 2>/dev/null; then
    warn "python3-pip/ensurepip not found — installing ..."
    sudo apt-get update -qq && sudo apt-get install -y -qq python3-pip
  fi
fi

# ── Submodule ──

if [ ! -f "$SUBMODULE_DIR/pyproject.toml" ]; then
  info "Initializing litellm submodule ..."
  git -C "$PROJECT_DIR" submodule update --init --depth 1 litellm
fi

# ── Virtualenv ──

if [ -d "$VENV_DIR" ]; then
  if [ "${LITELLM_REINSTALL_VENV:-}" = "1" ]; then
    info "Rebuilding virtualenv ..."
    rm -rf "$VENV_DIR"
    $PYTHON -m venv "$VENV_DIR"
  else
    info "Reusing existing virtualenv."
  fi
else
  info "Creating virtualenv at $VENV_DIR ..."
  $PYTHON -m venv "$VENV_DIR"
fi

# ── Activate ──

# shellcheck disable=SC1091
source "$VENV_DIR/bin/activate"

# ── Install dependencies ──

info "Upgrading pip ..."
pip install --upgrade pip --quiet 2>/dev/null

info "Installing litellm[proxy] (editable) ..."
pip install -e "$SUBMODULE_DIR[proxy]" --quiet 2>/dev/null
info "litellm installed."

# ── .env setup ──

if [ ! -f "$PROJECT_DIR/.env" ]; then
  if [ -f "$PROJECT_DIR/.env.example" ]; then
    cp "$PROJECT_DIR/.env.example" "$PROJECT_DIR/.env"
    sed -i.bak "s|/path/to/.litellm|$PROJECT_DIR|g" "$PROJECT_DIR/.env" 2>/dev/null || true
    rm -f "$PROJECT_DIR/.env.bak"
    warn "Created .env from template — edit to add your API keys"
  else
    warn "No .env file found. Copy the example and fill in your keys:"
    echo "  cp $PROJECT_DIR/.env.example $PROJECT_DIR/.env"
  fi
fi

# ── Sync auth file paths ──

"$BIN_DIR/litellmctl" init-env 2>/dev/null || true

# ── Shell completions ──

"$BIN_DIR/litellmctl" setup-completions 2>/dev/null || true

echo ""
info "Installation complete!"
echo ""
