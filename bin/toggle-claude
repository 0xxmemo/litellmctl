#!/bin/bash

BIN_DIR="$(cd "$(dirname "$0")" && pwd)"
PROJECT_DIR="$(cd "$BIN_DIR/.." && pwd)"
SETTINGS_FILE="$HOME/.claude/settings.json"
PORT_FILE="$PROJECT_DIR/.proxy-port"

# Load master key from .env
if [ -f "$PROJECT_DIR/.env" ]; then
  LITELLM_AUTH_TOKEN=$(grep -E '^LITELLM_MASTER_KEY=' "$PROJECT_DIR/.env" | cut -d'=' -f2-)
fi

if [ -z "$LITELLM_AUTH_TOKEN" ]; then
  echo "ERROR: LITELLM_MASTER_KEY not found in $PROJECT_DIR/.env"
  exit 1
fi

# Read the proxy port (from .proxy-port file or default 4000)
if [ -f "$PORT_FILE" ]; then
  PROXY_PORT=$(cat "$PORT_FILE")
else
  PROXY_PORT=4000
fi

LITELLM_BASE_URL="http://127.0.0.1:${PROXY_PORT}"

# Read current settings for ANTHROPIC_BASE_URL
CURRENT_BASE_URL=$(jq -r '.env.ANTHROPIC_BASE_URL // ""' "$SETTINGS_FILE")

if echo "$CURRENT_BASE_URL" | grep -q "127.0.0.1"; then
  echo "Switching Claude Code to use Direct Anthropic API (via OAuth)..."
  # Remove the entire env object
  jq 'del(.env)' "$SETTINGS_FILE" > tmp.$$.json && mv tmp.$$.json "$SETTINGS_FILE"
  echo "Claude Code now configured for Direct Anthropic API (OAuth)."
else
  echo "Switching Claude Code to use LiteLLM Proxy (port $PROXY_PORT)..."
  jq --arg base "$LITELLM_BASE_URL" --arg key "$LITELLM_AUTH_TOKEN" \
    '.env = {
      "ANTHROPIC_BASE_URL":              $base,
      "ANTHROPIC_AUTH_TOKEN":             $key,
      "ANTHROPIC_DEFAULT_OPUS_MODEL":    "claude-opus-4-6",
      "ANTHROPIC_DEFAULT_SONNET_MODEL":  "claude-sonnet-4-5-20250929",
      "ANTHROPIC_DEFAULT_HAIKU_MODEL":   "claude-haiku-4-5-20251001"
    }' "$SETTINGS_FILE" > tmp.$$.json && mv tmp.$$.json "$SETTINGS_FILE"
  echo "Claude Code now configured for LiteLLM Proxy at $LITELLM_BASE_URL."
  echo "  Opus:   claude-opus-4-6"
  echo "  Sonnet: claude-sonnet-4-5-20250929"
  echo "  Haiku:  claude-haiku-4-5-20251001"
fi

echo "Remember to restart Claude Code for changes to take full effect."
